{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Example - Mapping Grid Data to Vector Data\n",
    "\n",
    "This is useful in the case where you want to get statistics for a specific raster\n",
    "over a certain region. In this example, the vector data is a random region with\n",
    "soil information using SSURGO data."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "import json\n",
    "\n",
    "import geopandas\n",
    "\n",
    "from geocube.api.core import make_geocube\n",
    "\n",
    "%matplotlib inline"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [],
   "source": [
    "ssurgo_data = geopandas.read_file(\"../../test/test_data/input/soil_data_group.geojson\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>cokey</th>\n",
       "      <th>mukey</th>\n",
       "      <th>drclassdcd</th>\n",
       "      <th>hzdept_r</th>\n",
       "      <th>chkey</th>\n",
       "      <th>hzdepb_r</th>\n",
       "      <th>claytotal_r</th>\n",
       "      <th>sandtotal_r</th>\n",
       "      <th>silttotal_r</th>\n",
       "      <th>geometry</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>0</td>\n",
       "      <td>12577452</td>\n",
       "      <td>271425</td>\n",
       "      <td>Somewhat poorly drained</td>\n",
       "      <td>0.0</td>\n",
       "      <td>100034090</td>\n",
       "      <td>5.0</td>\n",
       "      <td>23.067675</td>\n",
       "      <td>9.978338</td>\n",
       "      <td>66.953987</td>\n",
       "      <td>MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>1</td>\n",
       "      <td>12577452</td>\n",
       "      <td>271425</td>\n",
       "      <td>Somewhat poorly drained</td>\n",
       "      <td>5.0</td>\n",
       "      <td>100034090</td>\n",
       "      <td>15.0</td>\n",
       "      <td>23.067675</td>\n",
       "      <td>9.978338</td>\n",
       "      <td>66.953987</td>\n",
       "      <td>MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>2</td>\n",
       "      <td>12577452</td>\n",
       "      <td>271425</td>\n",
       "      <td>Somewhat poorly drained</td>\n",
       "      <td>15.0</td>\n",
       "      <td>100034091</td>\n",
       "      <td>30.0</td>\n",
       "      <td>23.067675</td>\n",
       "      <td>9.978338</td>\n",
       "      <td>66.953987</td>\n",
       "      <td>MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>3</td>\n",
       "      <td>12577452</td>\n",
       "      <td>271425</td>\n",
       "      <td>Somewhat poorly drained</td>\n",
       "      <td>30.0</td>\n",
       "      <td>100034092</td>\n",
       "      <td>45.0</td>\n",
       "      <td>23.067675</td>\n",
       "      <td>9.978338</td>\n",
       "      <td>66.953987</td>\n",
       "      <td>MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>4</td>\n",
       "      <td>12577452</td>\n",
       "      <td>271425</td>\n",
       "      <td>Somewhat poorly drained</td>\n",
       "      <td>45.0</td>\n",
       "      <td>100034093</td>\n",
       "      <td>60.0</td>\n",
       "      <td>23.231643</td>\n",
       "      <td>9.961941</td>\n",
       "      <td>66.806416</td>\n",
       "      <td>MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "      cokey   mukey               drclassdcd  hzdept_r      chkey  hzdepb_r  \\\n",
       "0  12577452  271425  Somewhat poorly drained       0.0  100034090       5.0   \n",
       "1  12577452  271425  Somewhat poorly drained       5.0  100034090      15.0   \n",
       "2  12577452  271425  Somewhat poorly drained      15.0  100034091      30.0   \n",
       "3  12577452  271425  Somewhat poorly drained      30.0  100034092      45.0   \n",
       "4  12577452  271425  Somewhat poorly drained      45.0  100034093      60.0   \n",
       "\n",
       "   claytotal_r  sandtotal_r  silttotal_r  \\\n",
       "0    23.067675     9.978338    66.953987   \n",
       "1    23.067675     9.978338    66.953987   \n",
       "2    23.067675     9.978338    66.953987   \n",
       "3    23.067675     9.978338    66.953987   \n",
       "4    23.231643     9.961941    66.806416   \n",
       "\n",
       "                                            geometry  \n",
       "0  MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...  \n",
       "1  MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...  \n",
       "2  MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...  \n",
       "3  MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...  \n",
       "4  MULTIPOLYGON (((-90.59735 41.49255, -90.59730 ...  "
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "ssurgo_data.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [],
   "source": [
    "# convert the key to group to the vector data to an integer as that is one of the\n",
    "# best data types for this type of mapping. If your data is not integer,\n",
    "# then consider using a mapping of your data to an integer with something\n",
    "# like a categorical dtype.\n",
    "ssurgo_data[\"mukey\"] = ssurgo_data.mukey.astype(int)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Convert data to grid\n",
    "\n",
    "See docs for [make_geocube](../geocube.rst#make-geocube)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<xarray.Dataset>\n",
       "Dimensions:      (hzdept_r: 11, x: 165, y: 165)\n",
       "Coordinates:\n",
       "  * y            (y) float64 41.5 41.5 41.5 41.5 ... 41.48 41.48 41.48 41.48\n",
       "  * x            (x) float64 -90.6 -90.6 -90.6 -90.6 ... -90.58 -90.58 -90.58\n",
       "  * hzdept_r     (hzdept_r) float64 0.0 5.0 15.0 30.0 ... 90.0 105.0 120.0 150.0\n",
       "    spatial_ref  int64 0\n",
       "Data variables:\n",
       "    mukey        (hzdept_r, y, x) float64 1.988e+05 1.988e+05 ... 1.987e+05\n",
       "    hzdepb_r     (hzdept_r, y, x) float64 5.0 5.0 5.0 5.0 ... 180.0 180.0 180.0\n",
       "    claytotal_r  (hzdept_r, y, x) float64 26.0 26.0 26.0 26.0 ... 21.0 21.0 21.0\n",
       "    sandtotal_r  (hzdept_r, y, x) float64 38.0 38.0 38.0 38.0 ... 10.0 10.0 10.0\n",
       "    silttotal_r  (hzdept_r, y, x) float64 36.0 36.0 36.0 36.0 ... 69.0 69.0 69.0\n",
       "Attributes:\n",
       "    grid_mapping:  spatial_ref"
      ]
     },
     "execution_count": 5,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "out_grid = make_geocube(\n",
    "    vector_data=ssurgo_data,\n",
    "    group_by='hzdept_r',\n",
    "    resolution=(-0.0001, 0.0001)\n",
    ")\n",
    "out_grid"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "### Get the mean/median of each region using the unique ID"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>hzdept_r</th>\n",
       "      <th>spatial_ref</th>\n",
       "      <th>hzdepb_r</th>\n",
       "      <th>claytotal_r</th>\n",
       "      <th>sandtotal_r</th>\n",
       "      <th>silttotal_r</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>mukey</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>198692.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>23.000000</td>\n",
       "      <td>7.000000</td>\n",
       "      <td>70.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198714.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>87.000000</td>\n",
       "      <td>8.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198724.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>21.000000</td>\n",
       "      <td>10.000000</td>\n",
       "      <td>69.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198750.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>12.000000</td>\n",
       "      <td>63.000000</td>\n",
       "      <td>25.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198754.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>26.000000</td>\n",
       "      <td>38.000000</td>\n",
       "      <td>36.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>271425.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>23.067675</td>\n",
       "      <td>9.978338</td>\n",
       "      <td>66.953987</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>271431.0</td>\n",
       "      <td>15.0</td>\n",
       "      <td>0</td>\n",
       "      <td>30.0</td>\n",
       "      <td>14.000000</td>\n",
       "      <td>55.000000</td>\n",
       "      <td>31.000000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          hzdept_r  spatial_ref  hzdepb_r  claytotal_r  sandtotal_r  \\\n",
       "mukey                                                                 \n",
       "198692.0      15.0            0      30.0    23.000000     7.000000   \n",
       "198714.0      15.0            0      30.0     5.000000    87.000000   \n",
       "198724.0      15.0            0      30.0    21.000000    10.000000   \n",
       "198750.0      15.0            0      30.0    12.000000    63.000000   \n",
       "198754.0      15.0            0      30.0    26.000000    38.000000   \n",
       "271425.0      15.0            0      30.0    23.067675     9.978338   \n",
       "271431.0      15.0            0      30.0    14.000000    55.000000   \n",
       "\n",
       "          silttotal_r  \n",
       "mukey                  \n",
       "198692.0    70.000000  \n",
       "198714.0     8.000000  \n",
       "198724.0    69.000000  \n",
       "198750.0    25.000000  \n",
       "198754.0    36.000000  \n",
       "271425.0    66.953987  \n",
       "271431.0    31.000000  "
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "grid_mean = out_grid.sel(hzdept_r=15).groupby(out_grid.mukey.sel(hzdept_r=15)).mean()\n",
    "grid_mean.to_dataframe()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>hzdept_r</th>\n",
       "      <th>spatial_ref</th>\n",
       "      <th>hzdepb_r</th>\n",
       "      <th>claytotal_r</th>\n",
       "      <th>sandtotal_r</th>\n",
       "      <th>silttotal_r</th>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>mukey</th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "      <th></th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <td>198692.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>23.000000</td>\n",
       "      <td>7.000000</td>\n",
       "      <td>70.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198714.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>7.800000</td>\n",
       "      <td>86.466667</td>\n",
       "      <td>5.733333</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198724.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>21.000000</td>\n",
       "      <td>10.000000</td>\n",
       "      <td>69.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198750.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>12.000000</td>\n",
       "      <td>63.000000</td>\n",
       "      <td>25.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>198754.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>26.000000</td>\n",
       "      <td>38.000000</td>\n",
       "      <td>36.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>271425.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>24.564966</td>\n",
       "      <td>10.120497</td>\n",
       "      <td>65.314537</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <td>271431.0</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0</td>\n",
       "      <td>90.0</td>\n",
       "      <td>8.333333</td>\n",
       "      <td>74.666667</td>\n",
       "      <td>17.000000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "          hzdept_r  spatial_ref  hzdepb_r  claytotal_r  sandtotal_r  \\\n",
       "mukey                                                                 \n",
       "198692.0      75.0            0      90.0    23.000000     7.000000   \n",
       "198714.0      75.0            0      90.0     7.800000    86.466667   \n",
       "198724.0      75.0            0      90.0    21.000000    10.000000   \n",
       "198750.0      75.0            0      90.0    12.000000    63.000000   \n",
       "198754.0      75.0            0      90.0    26.000000    38.000000   \n",
       "271425.0      75.0            0      90.0    24.564966    10.120497   \n",
       "271431.0      75.0            0      90.0     8.333333    74.666667   \n",
       "\n",
       "          silttotal_r  \n",
       "mukey                  \n",
       "198692.0    70.000000  \n",
       "198714.0     5.733333  \n",
       "198724.0    69.000000  \n",
       "198750.0    25.000000  \n",
       "198754.0    36.000000  \n",
       "271425.0    65.314537  \n",
       "271431.0    17.000000  "
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "grid_median = out_grid.sel(hzdept_r=75).groupby(out_grid.mukey.sel(hzdept_r=75)).median()\n",
    "grid_median.to_dataframe()"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3.10.6 64-bit",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.6"
  },
  "vscode": {
   "interpreter": {
    "hash": "e7370f93d1d0cde622a1f8e1c04877d8463912d04d973331ad4851f04de6915a"
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
